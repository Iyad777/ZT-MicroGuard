apiVersion: v1
kind: ConfigMap
metadata:
  name: opa-policy
  namespace: zero-trust-demo
data:
  user-service-policy.rego: |
    package envoy.authz

    import rego.v1

    # Default deny
    default allow := false

    # Allow payment service to access /user-data
    allow if {
        input.attributes.request.http.method == "GET"
        input.attributes.request.http.path == "/user-data"
        input.attributes.request.http.headers["x-spiffe-id"] == "spiffe://example.org/payment-service"
    }

    # Allow health checks for everyone
    allow if {
        input.attributes.request.http.path == "/health"
    }
