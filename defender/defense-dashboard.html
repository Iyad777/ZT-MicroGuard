<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Defense Dashboard - ZT Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-900 via-slate-900 to-green-900 text-white min-h-screen">
    <div class="container mx-auto p-6">
        <div class="mb-8">
            <div class="flex items-center gap-3 mb-2">
                <i data-lucide="shield-check" class="w-10 h-10 text-green-500"></i>
                <h1 class="text-4xl font-bold text-green-500">ZERO TRUST DEFENSE</h1>
            </div>
            <p class="text-gray-400">Real-time monitoring of security policies and attack prevention</p>
        </div>

        <div class="bg-gradient-to-r from-green-600 to-blue-600 rounded-xl p-6 mb-6 shadow-2xl">
            <div class="flex items-center justify-between">
                <div>
                    <div class="text-sm text-white/80 mb-1">SYSTEM STATUS</div>
                    <div class="text-3xl font-bold">ALL SYSTEMS PROTECTED</div>
                </div>
                <div id="threatIndicator" class="flex items-center gap-3">
                    <div class="w-4 h-4 rounded-full bg-green-400 animate-pulse"></div>
                    <span class="text-xl font-semibold">SECURE</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-4 shadow-lg">
                <div class="flex items-center justify-between mb-2">
                    <i data-lucide="activity" class="w-5 h-5 text-white/80"></i>
                </div>
                <div class="text-3xl font-bold mb-1" id="totalRequests">0</div>
                <div class="text-sm text-white/80">Total Requests</div>
            </div>
            
            <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-4 shadow-lg">
                <div class="flex items-center justify-between mb-2">
                    <i data-lucide="check-circle" class="w-5 h-5 text-white/80"></i>
                </div>
                <div class="text-3xl font-bold mb-1" id="allowedCount">0</div>
                <div class="text-sm text-white/80">Allowed</div>
            </div>
            
            <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-xl p-4 shadow-lg">
                <div class="flex items-center justify-between mb-2">
                    <i data-lucide="shield-alert" class="w-5 h-5 text-white/80"></i>
                </div>
                <div class="text-3xl font-bold mb-1" id="blockedCount">0</div>
                <div class="text-sm text-white/80">Blocked Attacks</div>
            </div>
            
            <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-4 shadow-lg">
                <div class="flex items-center justify-between mb-2">
                    <i data-lucide="shield" class="w-5 h-5 text-white/80"></i>
                </div>
                <div class="text-3xl font-bold mb-1" id="blockRate">0%</div>
                <div class="text-sm text-white/80">Block Rate</div>
            </div>
        </div>

        <div class="bg-slate-800/50 backdrop-blur border border-green-500/30 rounded-xl p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                <i data-lucide="lock" class="w-5 h-5 text-green-400"></i>
                Active Security Policies
            </h2>
            <div class="space-y-3">
                <div class="flex items-center justify-between p-3 bg-green-500/10 border border-green-500/30 rounded-lg">
                    <div class="flex items-center gap-3">
                        <i data-lucide="check-circle" class="w-4 h-4 text-green-400"></i>
                        <span class="font-mono text-sm">
                            <span class="text-purple-400">payment-service</span>
                            <span class="text-gray-500 mx-2">‚Üí</span>
                            <span class="text-blue-400">/user-data</span>
                        </span>
                    </div>
                    <span class="px-3 py-1 bg-green-500/20 text-green-400 rounded-full text-xs font-semibold">ALLOW</span>
                </div>
                
                <div class="flex items-center justify-between p-3 bg-red-500/10 border border-red-500/30 rounded-lg">
                    <div class="flex items-center gap-3">
                        <i data-lucide="shield-alert" class="w-4 h-4 text-red-400"></i>
                        <span class="font-mono text-sm">
                            <span class="text-purple-400">malicious-service</span>
                            <span class="text-gray-500 mx-2">‚Üí</span>
                            <span class="text-blue-400">/user-data</span>
                        </span>
                    </div>
                    <span class="px-3 py-1 bg-red-500/20 text-red-400 rounded-full text-xs font-semibold">DENY</span>
                </div>
                
                <div class="flex items-center justify-between p-3 bg-green-500/10 border border-green-500/30 rounded-lg">
                    <div class="flex items-center gap-3">
                        <i data-lucide="check-circle" class="w-4 h-4 text-green-400"></i>
                        <span class="font-mono text-sm">
                            <span class="text-purple-400">*</span>
                            <span class="text-gray-500 mx-2">‚Üí</span>
                            <span class="text-blue-400">/health</span>
                        </span>
                    </div>
                    <span class="px-3 py-1 bg-green-500/20 text-green-400 rounded-full text-xs font-semibold">ALLOW</span>
                </div>
            </div>
        </div>

        <div class="bg-slate-800/50 backdrop-blur border border-green-500/30 rounded-xl p-6">
            <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                <i data-lucide="activity" class="w-5 h-5 text-green-400 animate-pulse"></i>
                Live Security Events
            </h2>
            <div id="securityLog" class="space-y-2 max-h-[500px] overflow-y-auto">
                <div class="text-gray-500 text-center py-8">
                    <i data-lucide="radio" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
                    <p>Monitoring for security events...</p>
                </div>
            </div>
        </div>

        <div class="mt-6 bg-slate-800/50 backdrop-blur border border-yellow-500/30 rounded-xl p-6">
            <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                <i data-lucide="alert-triangle" class="w-5 h-5 text-yellow-400"></i>
                Attack Pattern Visualization
            </h2>
            <div id="attackVisualization" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                </div>
        </div>
    </div>

    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
    lucide.createIcons();

    let stats = {
        total: 0,
        allowed: 0,
        blocked: 0
    };

    function updateStats() {
        document.getElementById('totalRequests').textContent = stats.total;
        document.getElementById('allowedCount').textContent = stats.allowed;
        document.getElementById('blockedCount').textContent = stats.blocked;
        
        const blockRate = stats.total > 0 ? Math.round((stats.blocked / stats.total) * 100) : 0;
        document.getElementById('blockRate').textContent = `${blockRate}%`;
    }

    function addSecurityEvent(event) {
        const log = document.getElementById('securityLog');
        const timestamp = new Date().toLocaleTimeString();
        
        // Clear placeholder
        if (log.querySelector('.text-gray-500')) {
            log.innerHTML = '';
        }

        // Update stats
        stats.total++;
        if (event.decision === 'allowed') {
            stats.allowed++;
        } else {
            stats.blocked++;
        }
        updateStats();

        // Update threat indicator
        if (event.decision === 'blocked') {
            const indicator = document.getElementById('threatIndicator');
            indicator.innerHTML = `
                <div class="w-4 h-4 rounded-full bg-red-500 animate-pulse"></div>
                <span class="text-xl font-semibold text-red-400">ATTACK DETECTED</span>
            `;
            setTimeout(() => {
                indicator.innerHTML = `
                    <div class="w-4 h-4 rounded-full bg-green-400 animate-pulse"></div>
                    <span class="text-xl font-semibold">SECURE</span>
                `;
            }, 3000);
        }
        
        const isAllowed = event.decision === 'allowed';
        const entry = document.createElement('div');
        entry.className = `p-4 rounded-lg border transition-all ${
            isAllowed 
                ? 'bg-green-500/5 border-green-500/30 hover:bg-green-500/10' 
                : 'bg-red-500/10 border-red-500/50 hover:bg-red-500/20'
        }`;
        
        entry.innerHTML = `
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4 flex-1">
                    <div class="p-2 rounded-lg ${isAllowed ? 'bg-green-500/20' : 'bg-red-500/20'}">
                        <i data-lucide="${isAllowed ? 'check-circle' : 'shield-alert'}" 
                           class="w-5 h-5 ${isAllowed ? 'text-green-400' : 'text-red-400'}"></i>
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-1">
                            <span class="font-mono text-sm text-purple-400">${event.service}</span>
                            <span class="text-gray-500">‚Üí</span>
                            <span class="font-mono text-sm text-blue-400">${event.method} ${event.path}</span>
                        </div>
                        <div class="text-xs text-gray-400 font-mono">${event.spiffeId}</div>
                        ${!isAllowed ? `<div class="text-xs text-red-400 mt-1">üõ°Ô∏è Lateral movement blocked by Zero Trust policy</div>` : ''}
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <span class="px-3 py-1 rounded-full text-xs font-semibold ${
                        isAllowed 
                            ? 'bg-green-500/20 text-green-400' 
                            : 'bg-red-500/20 text-red-400'
                    }">
                        ${isAllowed ? '‚úì ALLOWED' : '‚úó BLOCKED'}
                    </span>
                    <span class="text-gray-500 text-sm">${timestamp}</span>
                </div>
            </div>
        `;
        
        log.insertBefore(entry, log.firstChild);
        lucide.createIcons();

        // Add to attack visualization if blocked
        if (!isAllowed) {
            addAttackVisualization(event);
        }

        // Keep only last 20 events
        while (log.children.length > 20) {
            log.removeChild(log.lastChild);
        }
    }

    function addAttackVisualization(event) {
        const viz = document.getElementById('attackVisualization');
        const timestamp = new Date().toLocaleTimeString();
        
        const card = document.createElement('div');
        card.className = 'bg-red-500/10 border border-red-500/30 rounded-lg p-4 animate-pulse';
        card.innerHTML = `
            <div class="flex items-center gap-2 mb-2">
                <i data-lucide="alert-octagon" class="w-5 h-5 text-red-400"></i>
                <span class="font-semibold text-red-400">Attack Blocked</span>
            </div>
            <div class="text-sm space-y-1">
                <div><span class="text-gray-400">Time:</span> ${timestamp}</div>
                <div><span class="text-gray-400">Attacker:</span> <span class="text-purple-400 font-mono">${event.service}</span></div>
                <div><span class="text-gray-400">Target:</span> <span class="text-blue-400 font-mono">${event.path}</span></div>
                <div><span class="text-gray-400">Reason:</span> <span class="text-red-400">Policy violation</span></div>
            </div>
        `;
        
        viz.insertBefore(card, viz.firstChild);
        lucide.createIcons();
        
        // Remove animation after 2 seconds
        setTimeout(() => {
            card.classList.remove('animate-pulse');
        }, 2000);

        // Keep only last 6 attacks
        while (viz.children.length > 6) {
            viz.removeChild(viz.lastChild);
        }
    }

    // Real OPA log streaming
    function connectToOPAStream() {
        const eventSource = new EventSource('/api/stream');
        
        eventSource.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                
                if (data.type === 'security_event') {
                    addSecurityEvent(data);
                }
            } catch (e) {
                console.error('Error parsing SSE data:', e);
            }
        };
        
        eventSource.onerror = function(event) {
            console.error('SSE error:', event);
            // Attempt to reconnect after 5 seconds
            setTimeout(connectToOPAStream, 5000);
        };
        
        // Also fetch initial events
        fetch('/api/events')
            .then(response => response.json())
            .then(events => {
                events.forEach(event => addSecurityEvent(event));
            })
            .catch(error => console.error('Error fetching initial events:', error));
    }

    // Start real monitoring
    connectToOPAStream();
    </script>
</body>
</html>